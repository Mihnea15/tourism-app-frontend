<template>
    <!-- Componentele și conținutul paginii trebuie să fie HTML valid -->
    <div class="page" data-name="home">
        <!-- Left panel with cover effect-->
        <div class="panel panel-left panel-cover dark panel-init">
            <div class="view">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-bg"></div>
                        <div class="navbar-inner">
                            <div class="title">Left Panel</div>
                        </div>
                    </div>
                    <div class="page-content">
                        <div class="block">Left panel content goes here</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="left">
                    <a href="#" class="link icon-only panel-open" data-panel="left">
                        <i class="icon f7-icons if-not-md">menu</i>
                        <i class="icon material-icons if-md">menu</i>
                    </a>
                </div>
            </div>
        </div>
        <!-- Page Content -->
        <div class="page-content">
            <div class="list list-strong-ios list-outline-ios list-dividers-ios">
                <a href="#" class="item-link smart-select smart-select-init" data-open-in="sheet" @click=${e => updateMapBySelect(event)}>
                    <select name="select-cities">
                        ${cities.map((city) => $h`
                            <option value="${city.id}">${city.name}</option>
                        `)}
                    </select>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title">Select a city</div>
                            <div class="item-after" id="selected-city">Choose City</div>
                        </div>
                    </div>
                </a>
            </div>
            <div id="map" style="height: 400px;"></div>
        </div>
    </div>
</template>

<script>
    export default (props, {$on}) => {
        const cities = props.cities;

        $on('pageInit', () => {
            console.log(L)
            if (cities.length > 0) {
                initMap(cities[0].latitude, cities[0].longitude);
            }
        });

        let map;
        let marker;
        function initMap(latitude, longitude) {
            console.log(latitude, longitude)
            map = L.map('map').setView([latitude, longitude], 13); // Centrul hărții la coordonatele orașului

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            }).addTo(map);

            marker = L.marker([latitude, longitude]).addTo(map);
            marker.bindPopup(`<b>${cities[0].name}</b><br>Latitude: ${latitude}, Longitude: ${longitude}`).openPopup();
        }

        function updateMap(city) {
            if (map) {
                map.setView([city.latitude, city.longitude], 13);
                marker.setLatLng([city.latitude, city.longitude]);
                marker.bindPopup(`<b>${city.name}</b><br>Latitude: ${city.latitude}, Longitude: ${city.longitude}`).openPopup();
            } else {
                initMap(city.latitude, city.longitude);
            }
        }

        function updateMapBySelect(event) {
            const selectedCityId = event.target.value;
            const selectedCity = cities.find((city) => city.id === selectedCityId);

            if (selectedCity) {
                document.getElementById('selected-city').textContent = selectedCity.name;
                updateMap(selectedCity);
            }
        }

        return $render;
    };
</script>
